# Правила проекта Bench Energy News

**Не менять и не обнулять без необходимости.** Эти правила зафиксированы, чтобы настройки и процессы не сбрасывались при изменениях в коде или при смене разработчиков.

---

## 1. Деплой

### Сайт (Vercel)
- **Деплой только через GitHub:** push в `main` → Vercel собирает и деплоит. Не использовать `vercel deploy` и не деплоить вручную из Dashboard.
- **Перед каждым деплоем обязательно:** `npm run build` локально. Если сборка падает — сначала исправить, потом пушить.
- Подробно: [DEPLOYMENT_RULES.md](DEPLOYMENT_RULES.md).

### Бот на сервере
- Деплой бота: скрипт `deploy_to_server.sh` (читает `DEPLOY_SERVER`, `DEPLOY_USER`, `DEPLOY_PASSWORD` из `.env`).
- Логи бота: `check_server_logs.sh` — подключение по паролю через sshpass (как в CoinSpillX). В `.env`: `DEPLOY_PASSWORD` или `SERVER_PASS`.
- Если SSH с ноутбука не работает: зайти на сервер (панель Hetzner → Console или `ssh root@IP`) и выполнить **на сервере** скрипт `check_logs_on_server.sh` (логи смотрят локально на сервере).
- **Реальные логи бота** (stdout/stderr): на сервере в файле `/opt/bench-energy-news/bot/logs/bot_status.log`. `check_server_logs.sh` в конце выводит последние 40 строк этого файла.

---

## 2. Секреты и пароли

- **Пароли и ключи только в `.env`.** Не хардкодить в коде, не коммитить в репозиторий.
- `.env` в `.gitignore`. Шаблон переменных: [.env.example](.env.example).
- Скрипты с паролями (`deploy_to_server.sh`, `check_server_status.sh`) в `.gitignore` — не коммитить их с реальными данными.

---

## 3. Бот новостей: фильтры и пороги

**Не ослаблять и не ужесточать без явной причины.** Текущие значения подобраны, чтобы не было длительных периодов без новостей.

| Что | Значение | Где |
|-----|----------|-----|
| Минимальная длина summary при выборе новости | **500** символов | `bot/news_search.py` → `select_best_news()` |
| Минимальная длина summary при публикации | **100** символов | `bot/main.py` → `process_news()` |
| Валидация URL при поиске | **Выключена** | В `search_coal_news()` URL не проверяем — только при публикации в `process_news()`, чтобы не терять кандидатов из-за 403/таймаутов |

Если снова станет «нет новостей несколько дней» — сначала смотреть [bot/CHECK_NEWS_FILTERS.md](bot/CHECK_NEWS_FILTERS.md) (диагностика и что проверить на сервере).

---

## 4. Специальные посты о фрахте

- После каждых **5 обычных** постов — один специальный пост о фрахте (6-й, 12-й, 18-й...).
- Специальные посты не идут подряд: после фрахтового всегда следующий запуск — обычная новость.
- Логика счётчика: `bot/storage.py` → `should_generate_freight_post()`, `bot/main.py` → `increment_post_count()` после фрахтового поста.

---

## 5. Где что лежит

| Документ / файл | Назначение |
|-----------------|------------|
| **PROJECT_RULES.md** (этот файл) | Свод правил, не обнулять |
| **DEPLOYMENT_RULES.md** | Деплой Vercel, чеклист перед деплоем |
| **bot/CHECK_NEWS_FILTERS.md** | Почему нет новостей, фильтры, диагностика логов |
| **.env** | Секреты (не коммитить), шаблон — `.env.example` |
| **NEWS_SYNC_ARCHITECTURE.md** | Как синхронизируются новости (Notion API vs GitHub Actions) |

---

## 6. Что не делать

- Не понижать минимальную длину summary обратно до 700 в `select_best_news()` без обоснования.
- Не включать обратно валидацию URL при поиске в `search_coal_news()` — она отсекала всех кандидатов из-за 403.
- Не деплоить на Vercel без предварительного успешного `npm run build`.
- Не хранить пароли и ключи в коде или в закоммиченных файлах.

---

*Последнее обновление: 2026-01-31*
