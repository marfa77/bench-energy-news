name: Deploy to Vercel

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-vercel
  cancel-in-progress: false

jobs:
  sync-news:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Python dependencies
        run: |
          set -e
          echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
          cd bot
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install notion-client requests python-dotenv
          echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
      
      - name: Sync Notion to local
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          GITHUB_REPO_PATH: ${{ github.workspace }}
          SITE_URL: https://www.bench.energy
        run: |
          set -e
          echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ Notion ‚Üí Local"
          echo "üìÖ –î–∞—Ç–∞: $(date)"
          echo "üìÅ –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: ${{ github.workspace }}"
          cd bot
          python3 notion_sync.py
          echo "‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–æ–≤–æ—Å—Ç–µ–π –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
      
      - name: Sync Blog from Notion
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_BLOG_PAGE_ID: ${{ secrets.NOTION_BLOG_PAGE_ID }}
          GITHUB_REPO_PATH: ${{ github.workspace }}
          SITE_URL: https://www.bench.energy
        run: |
          set -e
          echo "üìù –ó–∞–ø—É—Å–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –±–ª–æ–≥–∞ –∏–∑ Notion"
          cd bot
          python3 blog_sync.py || echo "‚ö†Ô∏è  Blog sync failed (may not be configured)"
          echo "‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±–ª–æ–≥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
      
      - name: Generate RSS Feed
        run: |
          set -e
          echo "üì° –ì–µ–Ω–µ—Ä–∞—Ü–∏—è RSS feed..."
          python3 generate_rss.py
          echo "‚úÖ RSS feed —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω"
      
      - name: Commit and push changes
        run: |
          echo "üì§ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ GitHub..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          echo "üì¶ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –≤ git..."
          git add posts/ blog/ sitemap.xml index.html feed.xml || true
          if ! git diff --staged --quiet; then
            echo "üíæ –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞..."
            if git commit -m "Auto-sync: Update from Notion"; then
              echo "üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —É–¥–∞–ª–µ–Ω–Ω—ã–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º..."
              git pull --rebase origin main || true
              echo "üì° –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ GitHub..."
              if git push origin HEAD:main; then
                echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã"
              else
                echo "‚ùå –û—à–∏–±–∫–∞ git push. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞..."
                git status
                git log --oneline -5
                exit 1
              fi
            else
              echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–æ–º–º–∏—Ç (–≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π)"
            fi
          else
            echo "‚ÑπÔ∏è  –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          fi

  deploy-vercel:
    needs: sync-news
    if: always() # –ó–∞–ø—É—Å–∫–∞—Ç—å –¥–∞–∂–µ –µ—Å–ª–∏ sync-news –ø—Ä–æ–ø—É—â–µ–Ω –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Pull latest changes from sync-news
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git pull origin main || echo "‚ö†Ô∏è  No new changes to pull"
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Ensure blog directory exists
        run: |
          mkdir -p blog
          touch blog/.gitkeep || true
          echo "‚úÖ Blog directory ensured"
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Vercel CLI
        run: npm install --global vercel@latest
      
      - name: Create Vercel project config
        run: |
          mkdir -p .vercel
          echo "{\"orgId\":\"${{ secrets.VERCEL_ORG_ID }}\",\"projectId\":\"${{ secrets.VERCEL_PROJECT_ID }}\"}" > .vercel/project.json
      
      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }} || echo "‚ö†Ô∏è  Vercel pull failed, continuing..."
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      
      - name: Deploy to Vercel
        run: vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }} --yes
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1
