name: Test Secrets Configuration

on:
  workflow_dispatch:  # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤—Ä—É—á–Ω—É—é

jobs:
  test-notion:
    runs-on: ubuntu-latest
    steps:
      - name: Check Notion API Key
        run: |
          if [ -z "${{ secrets.NOTION_API_KEY }}" ]; then
            echo "‚ùå NOTION_API_KEY is not set"
            exit 1
          else
            echo "‚úÖ NOTION_API_KEY is set"
          fi
      
      - name: Check Notion Database ID
        run: |
          if [ -z "${{ secrets.NOTION_DATABASE_ID }}" ]; then
            echo "‚ùå NOTION_DATABASE_ID is not set"
            exit 1
          else
            echo "‚úÖ NOTION_DATABASE_ID is set"
          fi
      
      - name: Test Notion Connection
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: |
          echo "üîç Testing Notion API connection..."
          response=$(curl -s -w "\n%{http_code}" -X POST "https://api.notion.com/v1/databases/$NOTION_DATABASE_ID/query" \
            -H "Authorization: Bearer $NOTION_API_KEY" \
            -H "Notion-Version: 2022-06-28" \
            -H "Content-Type: application/json" \
            -d '{"page_size": 1}')
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          if [ "$http_code" = "200" ]; then
            echo "‚úÖ Notion API connection successful!"
            echo "Response preview:"
            echo "$body" | head -c 200
            echo "..."
          elif [ "$http_code" = "401" ]; then
            echo "‚ùå Notion API authentication failed"
            echo "Check that NOTION_API_KEY is correct and integration is connected to database"
            exit 1
          elif [ "$http_code" = "404" ]; then
            echo "‚ùå Notion database not found"
            echo "Check that NOTION_DATABASE_ID is correct"
            exit 1
          else
            echo "‚ùå Notion API error: HTTP $http_code"
            echo "Response: $body"
            exit 1
          fi

  test-vercel:
    runs-on: ubuntu-latest
    steps:
      - name: Check Vercel Token
        run: |
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
            echo "‚ùå VERCEL_TOKEN is not set"
            exit 1
          else
            echo "‚úÖ VERCEL_TOKEN is set"
          fi
      
      - name: Check Vercel Org ID
        run: |
          if [ -z "${{ secrets.VERCEL_ORG_ID }}" ]; then
            echo "‚ùå VERCEL_ORG_ID is not set"
            exit 1
          else
            echo "‚úÖ VERCEL_ORG_ID is set"
          fi
      
      - name: Check Vercel Project ID
        run: |
          if [ -z "${{ secrets.VERCEL_PROJECT_ID }}" ]; then
            echo "‚ùå VERCEL_PROJECT_ID is not set"
            exit 1
          else
            echo "‚úÖ VERCEL_PROJECT_ID is set"
          fi
      
      - name: Test Vercel Authentication
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          echo "üîç Testing Vercel API authentication..."
          response=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            "https://api.vercel.com/v2/user")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          if [ "$http_code" = "200" ]; then
            echo "‚úÖ Vercel API authentication successful!"
            echo "User info:"
            echo "$body" | grep -o '"username":"[^"]*"' | head -1 || echo "User authenticated"
          elif [ "$http_code" = "401" ] || [ "$http_code" = "403" ]; then
            echo "‚ùå Vercel API authentication failed"
            echo "Check that VERCEL_TOKEN is correct and not expired"
            exit 1
          else
            echo "‚ùå Vercel API error: HTTP $http_code"
            echo "Response: $body"
            exit 1
          fi
      
      - name: Test Vercel Project Access
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          echo "üîç Testing Vercel project access..."
          response=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            "https://api.vercel.com/v9/projects/$VERCEL_PROJECT_ID")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          if [ "$http_code" = "200" ]; then
            echo "‚úÖ Vercel project access successful!"
            echo "Project info:"
            echo "$body" | grep -o '"name":"[^"]*"' | head -1 || echo "Project found"
          elif [ "$http_code" = "404" ]; then
            echo "‚ùå Vercel project not found"
            echo "Check that VERCEL_PROJECT_ID is correct"
            echo "Make sure project exists in Vercel and is linked to this repository"
            exit 1
          elif [ "$http_code" = "403" ]; then
            echo "‚ùå Vercel project access denied"
            echo "Check that VERCEL_TOKEN has access to this project"
            echo "Check that VERCEL_ORG_ID matches the project's organization"
            exit 1
          else
            echo "‚ùå Vercel API error: HTTP $http_code"
            echo "Response: $body"
            exit 1
          fi

  summary:
    runs-on: ubuntu-latest
    needs: [test-notion, test-vercel]
    steps:
      - name: All Secrets Valid
        run: |
          echo "‚úÖ All secrets are configured correctly!"
          echo "‚úÖ Notion API connection works"
          echo "‚úÖ Vercel API authentication works"
          echo "‚úÖ Vercel project access works"
          echo ""
          echo "üöÄ You're ready to deploy!"
