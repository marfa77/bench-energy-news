name: Sync Notion to GitHub Pages

on:
  schedule:
    # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ä–∞–∑ –≤ –¥–µ–Ω—å –≤ 6:00 UTC (9:00 –ú–°–ö)
    # –û–±–Ω–æ–≤–ª—è–µ—Ç sitemap.xml –∏ feed.xml –¥–ª—è SEO –∏ RSS
    # –°—Ç—Ä–∞–Ω–∏—Ü–∞ /news —á–∏—Ç–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é –∏–∑ Notion API –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
    - cron: '0 6 * * *'
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

# –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–ø—É—Å–∫–∏ - –æ—Ç–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π, –µ—Å–ª–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π
concurrency:
  group: sync-notion
  cancel-in-progress: false  # –ù–µ –æ—Ç–º–µ–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –∑–∞–ø—É—Å–∫, –∂–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          set -e
          echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
          cd bot
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install notion-client requests
          echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
      
      - name: Sync Notion to GitHub Pages
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          GITHUB_REPO_PATH: ${{ github.workspace }}
          SITE_URL: https://marfa77.github.io/bench-energy-news
        run: |
          set -e
          echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ Notion ‚Üí GitHub Pages"
          echo "üìÖ –î–∞—Ç–∞: $(date)"
          echo "üìÅ –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: ${{ github.workspace }}"
          echo "üîë NOTION_API_KEY: $([ -n "$NOTION_API_KEY" ] && echo '—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' || echo '–ù–ï —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω')"
          echo "üîë NOTION_DATABASE_ID: $([ -n "$NOTION_DATABASE_ID" ] && echo '—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' || echo '–ù–ï —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω')"
          echo ""
          cd bot
          echo "üìÇ –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: $(pwd)"
          echo "üêç –ó–∞–ø—É—Å–∫ notion_sync.py..."
          python3 notion_sync.py
          echo "‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
      
      - name: Commit and push changes
        run: |
          echo "üì§ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ GitHub..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          echo "üì¶ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –≤ git..."
          git add posts/ sitemap.xml index.html feed.xml || true
          if ! git diff --staged --quiet; then
            echo "üíæ –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞..."
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º [skip actions] –≤–º–µ—Å—Ç–æ [skip ci] —á—Ç–æ–±—ã –Ω–µ –æ—Ç–º–µ–Ω—è—Ç—å workflow
            if git commit -m "Auto-sync: Update from Notion [ci actions]"; then
              echo "üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —É–¥–∞–ª–µ–Ω–Ω—ã–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º..."
              git pull --rebase origin main || true
              echo "üì° –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ GitHub..."
              if git push origin HEAD:main; then
                echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã"
              else
                echo "‚ùå –û—à–∏–±–∫–∞ git push. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞..."
                git status
                git log --oneline -5
                exit 1
              fi
            else
              echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–æ–º–º–∏—Ç (–≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π)"
            fi
          else
            echo "‚ÑπÔ∏è  –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          fi
